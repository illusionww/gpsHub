var map;var drivers={};$(document).ready(function(){initMap();bindListEvents();resizeList();moment.lang("ru");setInterval(getDriversLocation,1000)});function bindListEvents(){$list=$("#list");$list.find(".panel-heading").click(function(){var e=$(this).closest(".panel").attr("id").substring(7,10);var c=map.getLayers().getArray()[1].getSource().getFeatures();var a;c.forEach(function(f){if(f.id==e){a=f.getGeometry().getExtent()}});if(a!=undefined){var b=map.getView();var d=ol.animation.pan({duration:400,source:(b.getCenter())});map.beforeRender(d);b.setCenter([a[0],a[1]])}});$list.find(".ext-btn").click(function(){$collapse=$(this).closest(".panel").find(".panel-collapse");$collapse.collapse("toggle");return false});$panel_collapse=$(".panel-collapse");$panel_collapse.on("show.bs.collapse",function(){$span=$(this).closest(".panel").find(".ext-btn").find("span");$span.removeClass();$span.addClass("glyphicon glyphicon-chevron-up")});$panel_collapse.on("hide.bs.collapse",function(){$span=$(this).closest(".panel").find(".ext-btn").find("span");$span.removeClass();$span.addClass("glyphicon glyphicon-chevron-down")})}function initMap(){map=new ol.Map({target:"map-canvas",layers:[new ol.layer.Tile({source:new ol.source.OSM()}),new ol.layer.Vector({source:new ol.source.Vector()})],projection:"EPSG:3857",view:new ol.View2D({center:ol.proj.transform([37.61778,55.75167],"EPSG:4326","EPSG:3857"),zoom:11})});map.once("postrender",function(){initLayout();map.updateSize()})}function initLayout(){var a=$("#container").layout({closeable:false,slidable:false,center__paneSelector:"#map-layout",west__paneSelector:"#list-layout",center__minWidth:300,west__size:250,west__minSize:150,spacing_open:1,spacing_closed:20,livePaneResizing:true,stateManagement__enabled:true,onresize:function(){map.updateSize();resizeList()}});$("#list-layout-resizer").append("<div id='resizer-btn'><span class='glyphicon glyphicon-chevron-right'></span></div>");a.bindButton("#list-toggler","close","west");a.bindButton("#resizer-btn","open","west");$("#list-layout").show()}function resizeList(){if($("#list").width()<360){$(".panel-collapse .col-xs-6").width("70%")}else{$(".panel-collapse .col-xs-6").width("20%")}}function getDriversLocation(){$.ajax({url:"actions/drivers.php",type:"GET",data:{type:"location"},dataType:"json",success:function(a){a.list.forEach(function(b){if(b.id==null||b.lat==null||b.lng==null){$("#driver-"+b.id+"-panel .panel-heading").addClass("striped unknown");return}if(drivers[b.id]==undefined){drivers[b.id]=addPoint(b.id,b.lat,b.lng)}else{movePoint(b.id,b.lat,b.lng)}drivers[b.id].last_activity=b.last_activity});updateOnlineStatuses(a.time)}})}function updateOnlineStatuses(a){Object.keys(drivers).forEach(function(g){var f=a-drivers[g].last_activity;var e;if(f<60){e="online"}else{if(f<5*60){e="wait"}else{e="offline"}}if(drivers[g].status!==e){$circle=$("#driver-"+g+"-panel .circle");switch(e){case"online":$circle.removeClass("wait").addClass("online");break;case"wait":$circle.removeClass("online").addClass("wait");break;case"offline":$circle.removeClass("online").removeClass("wait");break}}var d=moment(drivers[g].last_activity,"X");var c=moment(a,"X");$("#driver-"+g+" .last-activity").text(d.from(c))})}function addPoint(f,c,e){var a=randomColor();$("#driver-"+f+"-panel .driver-color").css("background-color",a);if(typeof(c)=="string"){c=parseFloat(c)}if(typeof(e)=="string"){e=parseFloat(e)}var b=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform([e,c],"EPSG:4326","EPSG:3857"))});b.id=f;var d=new ol.style.Style({image:new ol.style.Icon({anchor:[0.5,46],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:0.75,src:"img/marker.php?color="+encodeURIComponent(a),size:[36,48]})});b.setStyle(d);map.getLayers().getArray()[1].getSource().addFeature(b);return b}function movePoint(d,b,c){if(typeof(b)=="string"){b=parseFloat(b)}if(typeof(c)=="string"){c=parseFloat(c)}var a=new ol.geom.Point(ol.proj.transform([c,b],"EPSG:4326","EPSG:3857"));drivers[d].set("geometry",a)}function randomColor(){var d=(Math.floor(Math.random()*16/3)*3).toString(16);var c=(Math.floor(Math.random()*16/3)*3).toString(16);var a=(Math.floor(Math.random()*16/3)*3).toString(16);color="#"+d.toString(16)+c.toString(16)+a.toString(16);return color};