var map;var driver={};$(document).ready(function(){initMap();bindListEvents();resizeList();moment.lang("ru");setInterval(getDrivers,1000)});function bindListEvents(){$list=$("#list");$list.find(".panel-heading").click(function(){var e=$(this).closest(".panel").attr("id").substring(7,10);var c=map.getLayers().getArray()[1].getSource().getFeatures();var a;c.forEach(function(f){if(f.id==e){a=f.getGeometry().getExtent()}});if(a!=undefined){var b=map.getView();var d=ol.animation.pan({duration:400,source:(b.getCenter())});map.beforeRender(d);b.setCenter([a[0],a[1]])}});$list.find(".ext-btn").click(function(){$collapse=$(this).closest(".panel").find(".panel-collapse");$collapse.collapse("toggle");return false});$panel_collapse=$(".panel-collapse");$panel_collapse.on("show.bs.collapse",function(){$span=$(this).closest(".panel").find(".ext-btn").find("span");$span.removeClass();$span.addClass("glyphicon glyphicon-chevron-up")});$panel_collapse.on("hide.bs.collapse",function(){$span=$(this).closest(".panel").find(".ext-btn").find("span");$span.removeClass();$span.addClass("glyphicon glyphicon-chevron-down")})}function initMap(){map=new ol.Map({target:"map-canvas",layers:[new ol.layer.Tile({source:new ol.source.OSM()}),new ol.layer.Vector({source:new ol.source.Vector()})],projection:"EPSG:3857",view:new ol.View2D({center:ol.proj.transform([37.61778,55.75167],"EPSG:4326","EPSG:3857"),zoom:11})});map.once("postrender",function(){initLayout();map.updateSize()})}function initLayout(){var a=$("#container").layout({closeable:false,slidable:false,center__paneSelector:"#map-layout",west__paneSelector:"#list-layout",center__minWidth:300,west__size:250,west__minSize:150,spacing_open:1,spacing_closed:20,livePaneResizing:true,stateManagement__enabled:true,onresize:function(){map.updateSize();resizeList()}});$("#list-layout-resizer").append("<div id='resizer-btn'><span class='glyphicon glyphicon-chevron-right'></span></div>");a.bindButton("#list-toggler","close","west");a.bindButton("#resizer-btn","open","west");$("#list-layout").show()}function resizeList(){if($("#list").width()<360){$(".panel-collapse .col-xs-6").width("70%")}else{$(".panel-collapse .col-xs-6").width("20%")}}function getDrivers(){$.ajax({url:"actions/drivers.php",type:"GET",dataType:"json",success:function(a){a.list.forEach(function(b){if(driver[b.id]==undefined){driver[b.id]=addPoint(b.id,b.lat,b.lng)}else{movePoint(b.id,b.lat,b.lng)}updateDriverStatus(b.id,b.time,a.time)})}})}function updateDriverStatus(h,f,e){$circle=$("#driver-"+h+"-panel .circle");var g=e-f;if(g<60){$circle.addClass("online")}else{if(g<5*60){$circle.removeClass("online").addClass("wait")}else{$circle.removeClass("online").removeClass("wait")}}var d=moment(f,"X");var c=moment(e,"X");$("#driver-"+h+" .last-activity").text(d.from(c))}function addPoint(h,e,g){var b=randomColor();$("#driver-"+h+"-panel .driver-color").css("background-color",b);var a=new ol.geom.Point(ol.proj.transform([g,e],"EPSG:4326","EPSG:3857"));var d=new ol.Feature({geometry:a});d.id=h;var c=new ol.style.Icon({anchor:[0.5,46],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:0.75,src:"actions/marker.php?color="+encodeURIComponent(b),size:[36,48]});var f=new ol.style.Style({image:c});d.setStyle(f);map.getLayers().getArray()[1].getSource().addFeature(d);return d}function movePoint(d,b,c){if(typeof(b)=="string"){b=parseFloat(b)}if(typeof(c)=="string"){c=parseFloat(c)}var a=new ol.geom.Point(ol.proj.transform([c,b],"EPSG:4326","EPSG:3857"));driver[d].set("geometry",a)}function randomColor(){var d=(Math.floor(Math.random()*16/3)*3).toString(16);var c=(Math.floor(Math.random()*16/3)*3).toString(16);var a=(Math.floor(Math.random()*16/3)*3).toString(16);color="#"+d.toString(16)+c.toString(16)+a.toString(16);return color}function buildModal(a){$("#modifyModalLabel").text("Пожалуйста, подождите...");$("#modify-name").val("");$("#modify-alias").val("");$("#modify-phone").val("");$("#modify-vehile-num").val("");$("#modify-vehile-description").val("");$("#modal-delete").unbind("click");$.ajax({url:"actions/drivers.php",type:"GET",data:{id:a},dataType:"json",success:function(b){$("#modifyModalLabel").text("Информация о водителе #"+b.driver_id);$("#modify-name").val(b.name);$("#modify-alias").val(b.alias);$("#modify-phone").val(b.phone_number);$("#modify-vehile-num").val(b.vehile_num);$("#modify-vehile-description").val(b.vehile_description);$("#modal-delete").click(function(){deleteDriver(b.driver_id);return false})}});$("#modifyModal").modal("show")}function modifyDriver(a){$.ajax({url:"actions/drivermanager.php",type:"POST",data:{action:"modify",driver_id:a,name:$("#modify-name").val(),alias:$("#modify-alias").val(),phone_number:$("#modify-phone").val(),vehile_num:$("#modify-vehile-num").val(),vehile_description:$("#modify-vehile-description").val()},dataType:"json",success:function(b){console.log(b);document.location.reload()}})}function deleteDriver(a){if(confirm("Вы уверены, что хотите удалить аккаунт водителя #"+a+"?")){$.ajax({url:"actions/drivermanager.php",type:"POST",data:{action:"delete",driver_id:a},dataType:"json",success:function(b){console.log(b);document.location.reload()}})}};