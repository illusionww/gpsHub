var layout;var map;var driver={};var type=false;$(document).ready(function(){initMap();setInterval(getDrivers,1000);$list=$("#list");$list.find(".panel-heading").click(function(){var e=$(this).closest(".panel").attr("id").substring(7,10);var c=map.getLayers().getArray()[1].getSource().getFeatures();var a;c.forEach(function(f){if(f.id==e){a=f.getGeometry().getExtent()}});if(a!=undefined){var b=map.getView();var d=ol.animation.pan({duration:400,source:(b.getCenter())});map.beforeRender(d);b.setCenter([a[0],a[1]])}});$list.find(".ext-btn").click(function(){$collapse=$(this).closest(".panel").find(".panel-collapse");$collapse.collapse("toggle");return false});$panel_collapse=$(".panel-collapse");$panel_collapse.on("show.bs.collapse",function(){$span=$(this).closest(".panel").find(".ext-btn").find("span");$span.removeClass();$span.addClass("glyphicon glyphicon-chevron-up")});$panel_collapse.on("hide.bs.collapse",function(){$span=$(this).closest(".panel").find(".ext-btn").find("span");$span.removeClass();$span.addClass("glyphicon glyphicon-chevron-down")})});function initMap(){map=new ol.Map({target:"map-canvas",layers:[new ol.layer.Tile({source:new ol.source.OSM()}),new ol.layer.Vector({source:new ol.source.Vector()})],projection:"EPSG:3857",view:new ol.View2D({center:ol.proj.transform([37.61778,55.75167],"EPSG:4326","EPSG:3857"),zoom:11})});map.on("postrender",function(){initLayout();map.updateSize()})}function initLayout(){layout=$("#container").layout({closeable:false,slidable:false,center__paneSelector:"#map-layout",west__paneSelector:"#list-layout",center__minWidth:300,west__size:250,spacing_open:1,spacing_closed:20,livePaneResizing:true,stateManagement__enabled:true,onresize:function(){map.updateSize()}});$("#list-layout").show()}function getDrivers(){$.ajax({url:"actions/drivers.php",type:"GET",dataType:"json",success:function(a){a.list.forEach(function(f){if(driver[f.id]==undefined){var e=randomColor();$("#driver-"+f.id+"-panel .driver-color").css("background-color",e);driver[f.id]=addPoint(f.lat,f.lng,f.id,e)}else{movePoint(f.id,f.lat,f.lng)}$circle=$("#driver-"+f.id+"-panel .circle");if(a.time-f.time<60*1000){$circle.addClass("online")}else{if(a.time-f.time<5*60*1000){$circle.removeClass("online").addClass("wait")}else{$circle.removeClass("online").removeClass("wait")}}moment.lang("ru");var d=moment(f.time,"X");var c=moment(a.time,"X");$("#driver-"+f.id+" th:last").text(d.from(c))})}})}function addPoint(c,e,f,a){var b=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform([e,c],"EPSG:4326","EPSG:3857"))});b.id=f;var d=new ol.style.Style({image:new ol.style.Icon(({anchor:[0.5,46],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:0.75,src:"actions/taxiimage.php?color="+encodeURIComponent(a),size:[36,48]}))});b.setStyle(d);map.getLayers().getArray()[1].getSource().addFeature(b);return b}function movePoint(c,a,b){if(typeof(a)=="string"){a=parseFloat(a)}if(typeof(b)=="string"){b=parseFloat(b)}driver[c].set("geometry",new ol.geom.Point(ol.proj.transform([b,a],"EPSG:4326","EPSG:3857")))}$(document).on("input",".clearable",function(){$(this)[tog(this.value)]("x")}).on("mousemove",".x",function(a){$(this)[tog(this.offsetWidth-18<a.clientX-this.getBoundingClientRect().left)]("onX")}).on("click",".onX",function(){$(this).removeClass("x onX").val("")});function tog(a){return a?"addClass":"removeClass"}function randomColor(){var d=(Math.floor(Math.random()*16/3)*3).toString(16);var c=(Math.floor(Math.random()*16/3)*3).toString(16);var a=(Math.floor(Math.random()*16/3)*3).toString(16);color="#"+d.toString(16)+c.toString(16)+a.toString(16);return color};