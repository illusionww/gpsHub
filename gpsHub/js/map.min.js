var map;var drivers={};var list_version;var loc_version;$(document).ready(function(){initMap();bindListToggle();resizeList();moment.lang("ru");getList();getDriversLocation();setInterval(getDriversLocation,1000)});function initMap(){map=new ol.Map({target:"map-canvas",layers:[new ol.layer.Tile({source:new ol.source.OSM()}),new ol.layer.Vector({source:new ol.source.Vector()})],projection:"EPSG:3857",view:new ol.View2D({center:ol.proj.transform([37.61778,55.75167],"EPSG:4326","EPSG:3857"),zoom:11})});map.once("postrender",function(){initLayout();map.updateSize()})}function initLayout(){var a=$("#container").layout({closeable:false,slidable:false,center__paneSelector:"#map-layout",west__paneSelector:"#list-layout",center__minWidth:300,west__size:250,west__minSize:150,spacing_open:1,spacing_closed:20,livePaneResizing:true,stateManagement__enabled:true,onresize:function(){map.updateSize();resizeList()}});$("#list-layout-resizer").append("<div id='resizer-btn'><span class='glyphicon glyphicon-chevron-right'></span></div>");a.bindButton("#list-toggler","close","west");a.bindButton("#resizer-btn","open","west");$("#list-layout").show()}function bindListToggle(){var a=$(".panel-collapse");a.on("show.bs.collapse",function(){var b=$(this).closest(".panel").find(".ext-btn").find("span");b.removeClass();b.addClass("glyphicon glyphicon-chevron-up")});a.on("hide.bs.collapse",function(){var b=$(this).closest(".panel").find(".ext-btn").find("span");b.removeClass();b.addClass("glyphicon glyphicon-chevron-down")})}function bindListMapping(){$("#list").find(".panel-heading").click(function(){var e=$(this).closest(".panel").attr("id").substring(7);var c=map.getLayers().getArray()[1].getSource().getFeatures();var a;c.forEach(function(f){if(f.id===e){a=f.getGeometry().getExtent()}});if(a!==undefined){var b=map.getView();var d=ol.animation.pan({duration:400,source:(b.getCenter())});map.beforeRender(d);b.setCenter([a[0],a[1]])}})}function resizeList(){if($("#list").width()<360){$(".panel-collapse .col-xs-6").width("70%")}else{$(".panel-collapse .col-xs-6").width("20%")}}function getList(){$.ajax({url:"actions/drivers.php",type:"GET",data:{type:"list"},dataType:"json",success:function(a){if(a&&a.list&&a.list_version!=list_version){$("#list").empty();a.list.forEach(function(b){addDriverToList(b)});bindListMapping();list_version=a.list_version}}})}function addDriverToList(e){var d=e.name!=undefined?e.name+"<br>"+e.vehile_num:"Нет информации <br> Id: "+e.driver_id;var b=[];b.push({name:"Id",value:e.driver_id});if(e.alias!=undefined&&e.alias!=""){b.push({name:"Позывной",value:e.alias})}if(e.phone_number!=undefined&&e.phone_number!=""){b.push({name:"Номер телефона",value:e.phone_number})}if(e.vehile_description!=undefined&&e.vehile_description!=""){b.push({name:"Описание машины",value:e.vehile_description})}b.push({name:"Последняя активность",value:"Нет информации",classname:"last-activity"});var a="";b.forEach(function(f){a+='<div class="row"><div class="col-xs-6">'+f.name+'</div><div class="col-xs-6 '+(f.classname?f.classname:"")+'">'+f.value+"</div></div>"});var c="";if(e.confirmed==0){c="striped unconfirmed"}$("#list").append('<div id="driver-'+e.driver_id+'" class="panel panel-default"><div class="panel-heading '+c+'"><div class="circle"></div><div class="driver-text">'+d+'</div><div class="right driver-color"></div><div class="right ext-btn" onclick="driverToggle('+e.driver_id+')"><span class="glyphicon glyphicon-chevron-down"></span></div></div><div id="driver-'+e.driver_id+'-collapse" class="panel-collapse collapse" data-parent="#list"><div class="panel-body">'+a+'<a href="#" onclick="buildModal('+e.driver_id+');">Изменить...</a></div></div></div>');if(drivers[e.driver_id]!=undefined){$("#driver-"+e.driver_id+" .driver-color").css("background-color",drivers[e.driver_id].color)}}function driverToggle(a){$("#driver-"+a+"-collapse").collapse("toggle");return false}function getDriversLocation(){$.ajax({url:"actions/drivers.php",type:"GET",data:{type:"location"},dataType:"json",success:function(a){if(a&&a.list&&a.loc_version!=loc_version){a.list.forEach(function(b){if(b.id===null||b.lat===null||b.lng===null){return}if(drivers[b.id]===undefined){drivers[b.id]=addPoint(b.id,b.lat,b.lng)}else{movePoint(b.id,b.lat,b.lng)}drivers[b.id].last_activity=b.last_activity})}updateOnlineStatuses(a.time);loc_version=a.loc_version}})}function addPoint(f,c,e){var a=randomColor();$("#driver-"+f+" .driver-color").css("background-color",a);if(typeof(c)==="string"){c=parseFloat(c)}if(typeof(e)==="string"){e=parseFloat(e)}var b=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform([e,c],"EPSG:4326","EPSG:3857"))});b.id=f;b.color=a;var d=new ol.style.Style({image:new ol.style.Icon({anchor:[0.5,46],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:0.75,src:"img/marker.php?color="+encodeURIComponent(a),size:[36,48]})});b.setStyle(d);map.getLayers().getArray()[1].getSource().addFeature(b);return b}function movePoint(d,b,c){if(typeof(b)==="string"){b=parseFloat(b)}if(typeof(c)==="string"){c=parseFloat(c)}var a=new ol.geom.Point(ol.proj.transform([c,b],"EPSG:4326","EPSG:3857"));drivers[d].set("geometry",a)}function updateOnlineStatuses(a){Object.keys(drivers).forEach(function(h){var g=a-drivers[h].last_activity;var f;if(g<60){f="online"}else{if(g<5*60){f="wait"}else{f="offline"}}if(drivers[h].status!==f){var d=$("#driver-"+h+" .circle");switch(f){case"online":d.removeClass("wait").addClass("online");break;case"wait":d.removeClass("online").addClass("wait");break;case"offline":d.removeClass("online").removeClass("wait");break}}var e=moment(drivers[h].last_activity,"X");var c=moment(a,"X");$("#driver-"+h+" .last-activity").text(e.from(c))})}function randomColor(){var d=(Math.floor(Math.random()*16/3)*3).toString(16);var c=(Math.floor(Math.random()*16/3)*3).toString(16);var a=(Math.floor(Math.random()*16/3)*3).toString(16);return"#"+d.toString(16)+c.toString(16)+a.toString(16)};